Test task.

A simple Python Flask application, returns:
* "Hello, user 'NAME'" on requests /user/NAME.
* "Hello, World!" on every other request.

Based on https://gitlab.com/vazhnov/gnss-web-control (Python, MIT license).

## GitHub actions requirements

A personal access token have to be created and stored into `secrets.PERSONAL_ACCESS_TOKEN_CONTAINER_REGISTRY` for GitHub actions workflow to be able to push container images into https://github.com/avazhnov-griddynamics/demo-service-ci/pkgs/container/python-flask-hello

### Container images repository

Images are generated by [GitHub actions](https://github.com/avazhnov-griddynamics/demo-service-ci/actions/workflows/tagging-docker-build-main.yaml) on commit into the main branch.

Images are stored in https://github.com/avazhnov-griddynamics/demo-service-ci/pkgs/container/python-flask-hello.

### Security checks

[Trivy vulnerability scanner] runs by [GitHub actions](https://github.com/avazhnov-griddynamics/demo-service-ci/actions/workflows/security_check_trivy.yaml) on every merge request created. Results are in Security â†’ [Code scanning](https://github.com/avazhnov-griddynamics/demo-service-ci/security/code-scanning) tab.

## minikube

Prepare minikube:

```sh
minikube addons enable ingress
bash ./build_minikube.sh
```

## Argo CD

[Install Argo CD](https://argo-cd.readthedocs.io/en/stable/getting_started/).

Add the Python Flask app into the Argo CD:

```sh
argocd app create 'python-flask-hello-argo-app' \
  --repo https://github.com/avazhnov-griddynamics/demo-service-ci.git \
  --path helm-chart \
  --helm-set replicaCount=2 \
  --dest-namespace python-flask-hello-argo \
  --dest-name minikube
argocd app sync 'python-flask-hello-argo-app'
```

Install [Polaris](https://github.com/FairwindsOps/polaris/blob/master/docs/dashboard.md) and [Goldilocks](https://github.com/FairwindsOps/goldilocks/blob/master/docs/installation.md) with ApplicationSet:

```sh
kubectl create namespace polaris-ns
kubectl create namespace goldilocks-ns
kubectl apply -n argocd -f Argo_CD/ApplicationSet_FairwindsOps.yaml
```

## How to

Check the Ingress works:

```sh
curl -H "Host: python-flask-hello.example.com" "http://$(minikube ip)/user/123"
```

## Known issues

* File `helm-chart/values.yaml` is changing automatically by [GitHub actions](https://github.com/avazhnov-griddynamics/demo-service-ci/actions/workflows/tagging-docker-build-main.yaml) on every commit into the main branch. Changes have to be pulled manually into developer's local repository.

## TODO

* [x] <del>pass kill signall from outside (for example, from `docker stop my-hello-app01`) to the app</del>.
* [x] <del>Check logs are writing</del>.
* [x] <del>Add healthchecks</del>.
* [x] <del>Support tags for deployment (to be able deploy not only `:latest`)</del>.
* [ ] Full templating of Helm chart, <del>including `host` in Ingress</del>.
* [x] <del>Run security check on every _commit_ in Pull request</del>.
* [ ] Better message/comment from Trivy vulnerability scanner, in addition to github-advanced-security bot.
* [ ] Use WSGI server (`gunicorn` / `uwsgi` + `nginx`) for Production.
* [ ] Auto cleanup old images from GitHub container registry.
